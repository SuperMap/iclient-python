import os
import httpretty
from io import StringIO
from unittest import TestCase, mock, skip
from iclientpy.rest.api.updatetileset import update_smtilestileset, _zip_files_in_workspace_directory as zipdir, \
    confirm, recache_tileset
from iclientpy.rest.api.model import PostFileUploadTaskResult


class TestUpdateTileSet(TestCase):
    @httpretty.activate
    def test_recache(self):
        base_uri = "http://192.168.20.158:8090/iserver"
        # do login
        loginuri = base_uri + '/services/security/login.json'
        httpretty.register_uri(httpretty.POST, loginuri, status=201,
                               set_cookie='JSESSIONID=958322873908FF9CA99B5CB443ADDD5C',
                               body='{"referer":"/iserver/","reason":null,"succeed":true}')
        # do post tile jobs
        post_tile_jobs_body = '{"postResultType":"CreateChild","newResourceID":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","succeed":true,"customResult":{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":null,"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[1.4062499999999996,0.7041106029214795,0.35205530146073977,0.17602765073036988,0.08801382536518494,0.04400691268259247,0.022003456341296235,0.011001728170648107,0.005500864085324063,0.002750432042662044],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":true,"refMapRestAdress":null,"scaleDenominators":[5.91658710909131E8,2.96244033181848E8,1.48122016590924E8,7.4061008295462E7,3.7030504147731E7,1.85152520738655E7,9257626.03693275,4628813.01846637,2314406.50923319,1157203.2546166],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0.75,"storageType":null,"vectorBounds":null,"vectorParameter":null}},"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json"}'
        httpretty.register_uri(httpretty.POST, base_uri + "/manager/tileservice/jobs.json", body=post_tile_jobs_body,
                               status=200)
        # do get tile job
        get_tile_jobs_body = '{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":{"masterAddress":null,"dataPreProcessBuildConfig":null,"tileMatrixEdgeCount":45,"dataPreProcessState":null,"total":122018,"startTime":1515746622436,"deployedCompleted":8,"tasks":[{"masterAddress":null,"isRetile":false,"jobId":"2288b51b-562c-4db7-a45d-8a2782126b24","tileMatrixToBuilds":[{"novalueFlags":null,"columnCount":45,"rowCount":45,"startingIndex":{"columnIndex":180,"rowIndex":0}}],"taskType":"TILETASK","originalPoint":{"x":-180,"y":90},"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"id":"650b0c99-db3e-4787-a5c7-58f1b5ba0f7a","state":{"workerId":null,"lastIndex":null,"completed":0,"runState":null},"deployTime":0,"totalTileCount":2025,"dataPreProcessInfo":null}],"buildingScale":{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"nextIndex":{"columnIndex":225,"rowIndex":0},"completed":8100,"completedBytes":0,"completedRegion":null},"scaleInfos":[{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"completed":8100,"completedBytes":18020057,"completedRegion":null}],"pureColorTileCount":5733,"deployedTotal":2025,"remainTime":1019842,"completed":8100,"analystBlankPercentage":0,"tasksToRetry":[],"deployingDataWorkerInfo":[],"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"completedScale":[],"runState":"COMPLETED","noFeaturesTileCount":0,"deployedWorkerInfo":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","name":"ubuntu_8090","controllable":false,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"completedBytes":18020057,"speedPerSecond":31,"elapsedTime":63297},"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[0.0028521510270794817],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":false,"refMapRestAdress":null,"scaleDenominators":[1200000],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0,"storageType":null,"vectorBounds":null,"vectorParameter":null}}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json',
                               body=get_tile_jobs_body, status=200)
        get_datastore_body = '{"tileSourceInfo":{"fdhtGroups":[["192.168.20.182:11411"]],"fdfsTrackers":["192.168.20.182:22122"],"type":"FastDFS","datastoreType":"TILES"},"connct":true,"currentCount":3,"id":"test","totalCount":3,"tilesetInfos":[{"metaData":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"originalPoint":{"x":-180,"y":90},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585],"tileWidth":256,"mapStatusHashCode":"914734962","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.0","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"fastdfs_tileset_1596041633","tileVersions":[{"parent":null,"name":"719ed1a8-cdbf-46cf-a15f-f0dd7c123042","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000,1200000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933,0.0028521510270794817]},"desc":"first version of tileset 1596041633","timestamp":1522475371281},{"parent":"719ed1a8-cdbf-46cf-a15f-f0dd7c123042","name":"dcd4f33d-fc48-4f80-b32a-db2ee440bd01","update":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V2","timestamp":1522640492532},{"parent":"dcd4f33d-fc48-4f80-b32a-db2ee440bd01","name":"c12d55a4-44dc-474c-a73d-65ad60596325","update":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"2018-04-02 14:27:38","timestamp":1522650458922},{"parent":"c12d55a4-44dc-474c-a73d-65ad60596325","name":"6a6da772-a615-49c4-9565-0c7407d54d50","update":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"2018-04-02 14:43:51","timestamp":1522651433013}]},{"metaData":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"originalPoint":{"x":-180,"y":90},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585],"tileWidth":256,"mapStatusHashCode":"-851947260","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.0","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World Map","tileHeight":256},"name":"fastdfs_tileset_-341902723","tileVersions":[{"parent":null,"name":"8addaea9-d42b-45cc-832a-70bdc75edcd5","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933]},"desc":"first version of tileset -341902723","timestamp":1522637457998},{"parent":"8addaea9-d42b-45cc-832a-70bdc75edcd5","name":"ea676727-2a10-49d5-9df4-58113c7d3559","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933]},"desc":"V2","timestamp":1522638495044},{"parent":"ea676727-2a10-49d5-9df4-58113c7d3559","name":"0026b12e-1235-4640-9361-ce350751c810","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933]},"desc":"V3","timestamp":1522639669452},{"parent":"0026b12e-1235-4640-9361-ce350751c810","name":"6d5ff0df-43ca-4e26-b254-885c2810fc0c","update":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V4","timestamp":1522639821615},{"parent":"6d5ff0df-43ca-4e26-b254-885c2810fc0c","name":"e0715672-afdc-409b-8462-aa38f2686ff0","update":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V5","timestamp":1522640036808},{"parent":"e0715672-afdc-409b-8462-aa38f2686ff0","name":"3220e3a9-5a4d-440a-b310-e4423db9ad06","update":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V6","timestamp":1522640206526}]},{"metaData":{"scaleDenominators":[4000,8000,16000,32000,64000,125000,250000],"originalPoint":{"x":-74.04927681498597,"y":40.849904671748604},"resolutions":[9.5071700903125E-6,1.901434018046875E-5,3.802868036109375E-5,7.605736072210938E-5,1.5211472144429687E-4,2.970990653208203E-4,5.941981306415624E-4],"tileWidth":256,"mapStatusHashCode":"940039246","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":40.849904671748604,"left":-74.04927681498597,"bottom":40.650255180584914,"leftBottom":{"x":-74.04927681498597,"y":40.650255180584914},"right":-73.84962732382229,"rightTop":{"x":-73.84962732382229,"y":40.849904671748604}},"tileRuleVersion":"1.0","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"summaryMesh_max_passenger_count_Map","tileHeight":256},"name":"fastdfs_tileset_-110794161","tileVersions":[{"parent":null,"name":"f6ebafff-da0d-4740-a766-1c45b80a8b0c","update":{"scaleDenominators":[250000,125000,64000,32000,16000,8000,4000],"bounds":{"top":40.849904671748604,"left":-74.04927681498597,"bottom":40.650255180584914,"leftBottom":{"x":-74.04927681498597,"y":40.650255180584914},"right":-73.84962732382229,"rightTop":{"x":-73.84962732382229,"y":40.849904671748604}},"resolutions":[5.941981306415624E-4,2.970990653208203E-4,1.5211472144429687E-4,7.605736072210938E-5,3.802868036109375E-5,1.901434018046875E-5,9.5071700903125E-6]},"desc":"first version of tileset -110794161","timestamp":1522465329328}]}]}'
        httpretty.register_uri(httpretty.GET, base_uri + '/manager/datastores/test.json',
                               body=get_datastore_body, status=200)
        recache_tileset(base_uri, 'admin', 'iserver', 'cache-World', 'World', 'test')

    @httpretty.activate
    @mock.patch('builtins.open', mock.mock_open(read_data='1'))
    def test_update_smtilestilset(self):
        base_uri = "http://192.168.20.158:8090/iserver"
        # do login
        loginuri = base_uri + '/services/security/login.json'
        httpretty.register_uri(httpretty.POST, loginuri, status=201,
                               set_cookie='JSESSIONID=958322873908FF9CA99B5CB443ADDD5C',
                               body='{"referer":"/iserver/","reason":null,"succeed":true}')
        # do post workspace
        httpretty.register_uri(httpretty.POST, base_uri + "/manager/workspaces.json",
                               body='[{"serviceType": "RESTMAP", "serviceAddress": "' + base_uri + '/services/data-world2/rest' + '"}]',
                               status=201)
        # do post tile jobs
        post_tile_jobs_body = '{"postResultType":"CreateChild","newResourceID":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","succeed":true,"customResult":{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":null,"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[1.4062499999999996,0.7041106029214795,0.35205530146073977,0.17602765073036988,0.08801382536518494,0.04400691268259247,0.022003456341296235,0.011001728170648107,0.005500864085324063,0.002750432042662044],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":true,"refMapRestAdress":null,"scaleDenominators":[5.91658710909131E8,2.96244033181848E8,1.48122016590924E8,7.4061008295462E7,3.7030504147731E7,1.85152520738655E7,9257626.03693275,4628813.01846637,2314406.50923319,1157203.2546166],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0.75,"storageType":null,"vectorBounds":null,"vectorParameter":null}},"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json"}'
        httpretty.register_uri(httpretty.POST, base_uri + "/manager/tileservice/jobs.json", body=post_tile_jobs_body,
                               status=200)
        # do get tile job
        get_tile_jobs_body = '{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":{"masterAddress":null,"dataPreProcessBuildConfig":null,"tileMatrixEdgeCount":45,"dataPreProcessState":null,"total":122018,"startTime":1515746622436,"deployedCompleted":8,"tasks":[{"masterAddress":null,"isRetile":false,"jobId":"2288b51b-562c-4db7-a45d-8a2782126b24","tileMatrixToBuilds":[{"novalueFlags":null,"columnCount":45,"rowCount":45,"startingIndex":{"columnIndex":180,"rowIndex":0}}],"taskType":"TILETASK","originalPoint":{"x":-180,"y":90},"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"id":"650b0c99-db3e-4787-a5c7-58f1b5ba0f7a","state":{"workerId":null,"lastIndex":null,"completed":0,"runState":null},"deployTime":0,"totalTileCount":2025,"dataPreProcessInfo":null}],"buildingScale":{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"nextIndex":{"columnIndex":225,"rowIndex":0},"completed":8100,"completedBytes":0,"completedRegion":null},"scaleInfos":[{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"completed":8100,"completedBytes":18020057,"completedRegion":null}],"pureColorTileCount":5733,"deployedTotal":2025,"remainTime":1019842,"completed":8100,"analystBlankPercentage":0,"tasksToRetry":[],"deployingDataWorkerInfo":[],"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"completedScale":[],"runState":"COMPLETED","noFeaturesTileCount":0,"deployedWorkerInfo":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","name":"ubuntu_8090","controllable":false,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"completedBytes":18020057,"speedPerSecond":31,"elapsedTime":63297},"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[0.0028521510270794817],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":false,"refMapRestAdress":null,"scaleDenominators":[1200000],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0,"storageType":null,"vectorBounds":null,"vectorParameter":null}}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json',
                               body=get_tile_jobs_body, status=200)
        # post update jobs
        post_update_jobs_body = '{"postResultType":"CreateChild","newResourceID":"f1341552-d09f-456d-8c06-0b04612b5762","succeed":true,"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/tilesetupdatejobs/f1341552-d09f-456d-8c06-0b04612b5762.json"}'
        httpretty.register_uri(httpretty.POST, base_uri + '/manager/tilesetupdatejobs.json', body=post_update_jobs_body,
                               status=200)
        # get update job
        get_update_job_body = '{"id":"f1341552-d09f-456d-8c06-0b04612b5762","state":{"total":14654,"completedScales":[{"tileMatrix":{"novalueFlags":null,"columnCount":3,"rowCount":2,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":6,"scaleDenominator":2.4999999999934435E8,"completed":6,"resolution":0.59419813064}],"actualCompleted":12,"toExportScales":[{"tileMatrix":{"novalueFlags":null,"columnCount":10,"rowCount":5,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":50,"scaleDenominator":6.399999999821653E7,"completed":0,"resolution":0.15211472144},{"tileMatrix":{"novalueFlags":null,"columnCount":19,"rowCount":10,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":190,"scaleDenominator":3.1999999999949735E7,"completed":0,"resolution":0.076057360722},{"tileMatrix":{"novalueFlags":null,"columnCount":37,"rowCount":19,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":703,"scaleDenominator":1.5999999999974867E7,"completed":0,"resolution":0.038028680361},{"tileMatrix":{"novalueFlags":null,"columnCount":74,"rowCount":37,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":2738,"scaleDenominator":8000000.000197801,"completed":0,"resolution":0.019014340181},{"tileMatrix":{"novalueFlags":null,"columnCount":148,"rowCount":74,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":10952,"scaleDenominator":4000000.000014754,"completed":0,"resolution":0.0095071700903}],"exporttingScale":{"tileMatrix":{"novalueFlags":null,"columnCount":5,"rowCount":3,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":15,"scaleDenominator":1.2499999999967217E8,"nextIndex":{"columnIndex":2,"rowIndex":6},"completed":6,"resolution":0.29709906532},"startTime":1516238843458,"remainTime":334326,"completed":12,"runState":"COMPLETED","elapsedTime":274,"speedPerSecond":57},"info":{"sourceTilesetInfo":{"metaData":{"scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"originalPoint":{"x":-180,"y":90},"standardMBTiles":false,"resolutions":[0.59419813064,0.29709906532,0.15211472144,0.076057360722,0.038028680361,0.019014340181,0.0095071700903],"tileWidth":256,"mapStatusHashCode":"1318435482","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.1","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"smtiles_tileset_1596041633","tileVersions":null},"targetTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12","type":"SMTiles"},"targetInfo":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"relatedObject":null,"sourceTilesetDesc":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13/World_1318435482_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"sourceTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13","type":"SMTiles"},"targetTilesetIdentifier":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileVersions":null,"targetTilesetInfo":{"metaData":{"scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"originalPoint":{"x":-180,"y":90},"standardMBTiles":false,"resolutions":[0.59419813064,0.29709906532,0.15211472144,0.076057360722,0.038028680361,0.019014340181,0.0095071700903],"tileWidth":256,"mapStatusHashCode":"1179708792","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.1","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"smtiles_tileset_1596041633","tileVersions":null},"targetTilesetDesc":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"sourceTilesetIdentifier":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13/World_1318435482_256X256_PNG.smtiles"}}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/tilesetupdatejobs/f1341552-d09f-456d-8c06-0b04612b5762.json',
                               body=get_update_job_body, status=200)
        # delete map component
        httpretty.register_uri(httpretty.DELETE,
                               base_uri + '/manager/services/data-world2.json',
                               body='{"succeed": true}', status=200)
        # get map info
        get_map_body = '{"viewBounds":{"top":76.05736072192,"left":-76.05736072192,"bottom":-76.05736072192,"leftBottom":{"x":-76.05736072192,"y":-76.05736072192},"right":76.05736072192,"rightTop":{"x":76.05736072192,"y":76.05736072192}},"viewer":{"leftTop":{"x":0,"y":0},"top":0,"left":0,"bottom":256,"rightBottom":{"x":256,"y":256},"width":256,"right":256,"height":256},"distanceUnit":null,"minVisibleTextSize":0,"coordUnit":"DEGREE","scale":4.0000000000104906E-9,"description":"","paintBackground":false,"maxVisibleTextSize":0,"maxVisibleVertex":0,"clipRegionEnabled":false,"antialias":false,"textOrientationFixed":false,"angle":0,"prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"minScale":0,"markerAngleFixed":false,"overlapDisplayedOptions":null,"visibleScales":[4.0000000000104906E-9,8.000000000020981E-9,1.5625000000435417E-8,3.125000000004909E-8,6.250000000009817E-8,1.2499999999690936E-7,2.499999999990779E-7],"visibleScalesEnabled":true,"customEntireBoundsEnabled":false,"clipRegion":null,"maxScale":0,"customParams":"","center":{"x":0,"y":0},"dynamicPrjCoordSyses":[{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}}],"colorMode":null,"textAngleFixed":false,"overlapDisplayed":false,"userToken":{"userID":""},"cacheEnabled":true,"dynamicProjection":false,"autoAvoidEffectEnabled":true,"customEntireBounds":null,"name":"World","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"backgroundStyle":{"fillGradientOffsetRatioX":0,"markerSize":0,"fillForeColor":{"red":255,"green":0,"blue":0,"alpha":255},"fillGradientOffsetRatioY":0,"markerWidth":0,"markerAngle":0,"fillSymbolID":0,"lineColor":{"red":0,"green":0,"blue":0,"alpha":255},"markerSymbolID":0,"lineWidth":0.01,"markerHeight":0,"fillOpaqueRate":100,"fillBackOpaque":false,"fillBackColor":{"red":255,"green":255,"blue":255,"alpha":255},"fillGradientMode":"NONE","lineSymbolID":0,"fillGradientAngle":0}}'
        httpretty.register_uri(httpretty.GET, base_uri + "/services/cache-World/rest/maps/World.json",
                               body=get_map_body, status=200)
        get_mng_service_body = '{"isStreamingService":false,"interfaceTypes":"com.supermap.services.rest.RestServlet","isSet":false,"instances":[{"interfaceType":"com.supermap.services.rest.RestServlet","componentType":"com.supermap.services.components.impl.MapImpl","name":"cache-World/rest","componentSetName":null,"authorizeSetting":{"permittedRoles":[],"deniedRoles":[],"type":"PUBLIC"},"id":null,"componentName":"map-smtiles-World2","interfaceName":"rest","enabled":true,"status":"OK"}],"isClusterService":false,"type":"com.supermap.services.components.impl.MapImpl","interfaceNames":"rest","clusterInterfaceNames":"","isDataflowService":false,"component":{"isScSet":false,"scSetSetting":null,"scSetting":{"disabledInterfaceNames":"","instanceCount":0,"name":"map-smtiles-World2","alias":"","interfaceNames":"rest","type":"com.supermap.services.components.impl.MapImpl","config":{"cacheReadOnly":false,"cacheConfigs":null,"useVectorTileCache":false,"utfGridCacheConfig":null,"tileCacheConfig":null,"vectorTileCacheConfig":null,"expired":0,"logLevel":"info","outputPath":"","useCache":false,"outputSite":"","useUTFGridCache":false,"clip":false},"providers":"smtiles-World2","enabled":true}},"providerNames":"smtiles-World2","name":"cache-World","alias":"","providers":[{"spsetSetting":null,"isSPSet":false,"spSetting":{"name":"smtiles-World2","alias":null,"innerProviders":null,"type":"com.supermap.services.providers.SMTilesMapProvider","config":{"dataPrjCoordSysType":null,"watermark":null,"cacheVersion":"4.0","outputPath":"./output","filePath":"/etc/icloud/SuperMapiServer/bin/iserver/output/sqlite113/World_1881337416_256X256_PNG.smtiles","cacheMode":null,"name":null,"outputSite":"http://{ip}:{port}/iserver/output/"},"enabled":true}}]}'
        httpretty.register_uri(httpretty.GET, base_uri + "/manager/services/cache-World.json",
                               body=get_mng_service_body, status=200)
        # post file upload tasks
        post_fileuploadtasks_body = '{"newResourceID":"38efbec5de2846d1bd499866637aec46_74d0dd27cf454fe1875f0b94490e7280","succeed":true,"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/filemanager/uploadtasks/38efbec5de2846d1bd499866637aec46_74d0dd27cf454fe1875f0b94490e7280"}'
        httpretty.register_uri(httpretty.POST, base_uri + '/manager/filemanager/uploadtasks.json',
                               body=post_fileuploadtasks_body, status=200)
        # post file upload task
        post_fileuploadtask_body = '{"fileName":"World0","fileSize":0,"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/./World0/","isDirectory":true}'
        httpretty.register_uri(httpretty.POST,
                               base_uri + '/manager/filemanager/uploadtasks/38efbec5de2846d1bd499866637aec46_74d0dd27cf454fe1875f0b94490e7280.json',
                               body=post_fileuploadtask_body, status=200)
        # get file upload task
        get_fileuploadtask_body = '{"uploadedByteCount":0,"path":"/etc/icloud/SuperMapiServer/upload","progress":100,"state":"COMPLETED","uploadedDataMD5":null,"taskID":"38efbec5de2846d1bd499866637aec46_9f2791745913493abe53d2db755ecaf1","md5":null}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/filemanager/uploadtasks/38efbec5de2846d1bd499866637aec46_74d0dd27cf454fe1875f0b94490e7280.json',
                               body=get_fileuploadtask_body, status=200)
        update_smtilestileset(base_uri, 'admin', 'iserver', 'cache-World',
                              os.path.join(os.path.dirname(os.path.abspath(__file__)), "World.zip"), 'World',
                              (-180, 90), (-180, -90, 180, 90), quiet=True)

    @httpretty.activate
    def test_update_smtilestilset_remote_workspace(self):
        base_uri = "http://192.168.20.158:8090/iserver"
        # do login
        loginuri = base_uri + '/services/security/login.json'
        httpretty.register_uri(httpretty.POST, loginuri, status=201,
                               set_cookie='JSESSIONID=958322873908FF9CA99B5CB443ADDD5C',
                               body='{"referer":"/iserver/","reason":null,"succeed":true}')
        # do post workspace
        httpretty.register_uri(httpretty.POST, base_uri + "/manager/workspaces.json",
                               body='[{"serviceType": "RESTMAP", "serviceAddress": "' + base_uri + '/services/data-world2/rest' + '"}]',
                               status=201)
        # do post tile jobs
        post_tile_jobs_body = '{"postResultType":"CreateChild","newResourceID":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","succeed":true,"customResult":{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":null,"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[1.4062499999999996,0.7041106029214795,0.35205530146073977,0.17602765073036988,0.08801382536518494,0.04400691268259247,0.022003456341296235,0.011001728170648107,0.005500864085324063,0.002750432042662044],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":true,"refMapRestAdress":null,"scaleDenominators":[5.91658710909131E8,2.96244033181848E8,1.48122016590924E8,7.4061008295462E7,3.7030504147731E7,1.85152520738655E7,9257626.03693275,4628813.01846637,2314406.50923319,1157203.2546166],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0.75,"storageType":null,"vectorBounds":null,"vectorParameter":null}},"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json"}'
        httpretty.register_uri(httpretty.POST, base_uri + "/manager/tileservice/jobs.json", body=post_tile_jobs_body,
                               status=200)
        # do get tile job
        get_tile_jobs_body = '{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":{"masterAddress":null,"dataPreProcessBuildConfig":null,"tileMatrixEdgeCount":45,"dataPreProcessState":null,"total":122018,"startTime":1515746622436,"deployedCompleted":8,"tasks":[{"masterAddress":null,"isRetile":false,"jobId":"2288b51b-562c-4db7-a45d-8a2782126b24","tileMatrixToBuilds":[{"novalueFlags":null,"columnCount":45,"rowCount":45,"startingIndex":{"columnIndex":180,"rowIndex":0}}],"taskType":"TILETASK","originalPoint":{"x":-180,"y":90},"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"id":"650b0c99-db3e-4787-a5c7-58f1b5ba0f7a","state":{"workerId":null,"lastIndex":null,"completed":0,"runState":null},"deployTime":0,"totalTileCount":2025,"dataPreProcessInfo":null}],"buildingScale":{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"nextIndex":{"columnIndex":225,"rowIndex":0},"completed":8100,"completedBytes":0,"completedRegion":null},"scaleInfos":[{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"completed":8100,"completedBytes":18020057,"completedRegion":null}],"pureColorTileCount":5733,"deployedTotal":2025,"remainTime":1019842,"completed":8100,"analystBlankPercentage":0,"tasksToRetry":[],"deployingDataWorkerInfo":[],"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"completedScale":[],"runState":"COMPLETED","noFeaturesTileCount":0,"deployedWorkerInfo":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","name":"ubuntu_8090","controllable":false,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"completedBytes":18020057,"speedPerSecond":31,"elapsedTime":63297},"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[0.0028521510270794817],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":false,"refMapRestAdress":null,"scaleDenominators":[1200000],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0,"storageType":null,"vectorBounds":null,"vectorParameter":null}}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json',
                               body=get_tile_jobs_body, status=200)
        # post update jobs
        post_update_jobs_body = '{"postResultType":"CreateChild","newResourceID":"f1341552-d09f-456d-8c06-0b04612b5762","succeed":true,"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/tilesetupdatejobs/f1341552-d09f-456d-8c06-0b04612b5762.json"}'
        httpretty.register_uri(httpretty.POST, base_uri + '/manager/tilesetupdatejobs.json', body=post_update_jobs_body,
                               status=200)
        # get update job
        get_update_job_body = '{"id":"f1341552-d09f-456d-8c06-0b04612b5762","state":{"total":14654,"completedScales":[{"tileMatrix":{"novalueFlags":null,"columnCount":3,"rowCount":2,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":6,"scaleDenominator":2.4999999999934435E8,"completed":6,"resolution":0.59419813064}],"actualCompleted":12,"toExportScales":[{"tileMatrix":{"novalueFlags":null,"columnCount":10,"rowCount":5,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":50,"scaleDenominator":6.399999999821653E7,"completed":0,"resolution":0.15211472144},{"tileMatrix":{"novalueFlags":null,"columnCount":19,"rowCount":10,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":190,"scaleDenominator":3.1999999999949735E7,"completed":0,"resolution":0.076057360722},{"tileMatrix":{"novalueFlags":null,"columnCount":37,"rowCount":19,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":703,"scaleDenominator":1.5999999999974867E7,"completed":0,"resolution":0.038028680361},{"tileMatrix":{"novalueFlags":null,"columnCount":74,"rowCount":37,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":2738,"scaleDenominator":8000000.000197801,"completed":0,"resolution":0.019014340181},{"tileMatrix":{"novalueFlags":null,"columnCount":148,"rowCount":74,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":10952,"scaleDenominator":4000000.000014754,"completed":0,"resolution":0.0095071700903}],"exporttingScale":{"tileMatrix":{"novalueFlags":null,"columnCount":5,"rowCount":3,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":15,"scaleDenominator":1.2499999999967217E8,"nextIndex":{"columnIndex":2,"rowIndex":6},"completed":6,"resolution":0.29709906532},"startTime":1516238843458,"remainTime":334326,"completed":12,"runState":"COMPLETED","elapsedTime":274,"speedPerSecond":57},"info":{"sourceTilesetInfo":{"metaData":{"scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"originalPoint":{"x":-180,"y":90},"standardMBTiles":false,"resolutions":[0.59419813064,0.29709906532,0.15211472144,0.076057360722,0.038028680361,0.019014340181,0.0095071700903],"tileWidth":256,"mapStatusHashCode":"1318435482","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.1","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"smtiles_tileset_1596041633","tileVersions":null},"targetTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12","type":"SMTiles"},"targetInfo":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"relatedObject":null,"sourceTilesetDesc":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13/World_1318435482_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"sourceTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13","type":"SMTiles"},"targetTilesetIdentifier":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileVersions":null,"targetTilesetInfo":{"metaData":{"scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"originalPoint":{"x":-180,"y":90},"standardMBTiles":false,"resolutions":[0.59419813064,0.29709906532,0.15211472144,0.076057360722,0.038028680361,0.019014340181,0.0095071700903],"tileWidth":256,"mapStatusHashCode":"1179708792","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.1","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"smtiles_tileset_1596041633","tileVersions":null},"targetTilesetDesc":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"sourceTilesetIdentifier":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13/World_1318435482_256X256_PNG.smtiles"}}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/tilesetupdatejobs/f1341552-d09f-456d-8c06-0b04612b5762.json',
                               body=get_update_job_body, status=200)
        # delete map component
        httpretty.register_uri(httpretty.DELETE,
                               base_uri + '/manager/services/data-world2.json',
                               body='{"succeed": true}', status=200)
        # get map info
        get_map_body = '{"viewBounds":{"top":76.05736072192,"left":-76.05736072192,"bottom":-76.05736072192,"leftBottom":{"x":-76.05736072192,"y":-76.05736072192},"right":76.05736072192,"rightTop":{"x":76.05736072192,"y":76.05736072192}},"viewer":{"leftTop":{"x":0,"y":0},"top":0,"left":0,"bottom":256,"rightBottom":{"x":256,"y":256},"width":256,"right":256,"height":256},"distanceUnit":null,"minVisibleTextSize":0,"coordUnit":"DEGREE","scale":4.0000000000104906E-9,"description":"","paintBackground":false,"maxVisibleTextSize":0,"maxVisibleVertex":0,"clipRegionEnabled":false,"antialias":false,"textOrientationFixed":false,"angle":0,"prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"minScale":0,"markerAngleFixed":false,"overlapDisplayedOptions":null,"visibleScales":[4.0000000000104906E-9,8.000000000020981E-9,1.5625000000435417E-8,3.125000000004909E-8,6.250000000009817E-8,1.2499999999690936E-7,2.499999999990779E-7],"visibleScalesEnabled":true,"customEntireBoundsEnabled":false,"clipRegion":null,"maxScale":0,"customParams":"","center":{"x":0,"y":0},"dynamicPrjCoordSyses":[{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}}],"colorMode":null,"textAngleFixed":false,"overlapDisplayed":false,"userToken":{"userID":""},"cacheEnabled":true,"dynamicProjection":false,"autoAvoidEffectEnabled":true,"customEntireBounds":null,"name":"World","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"backgroundStyle":{"fillGradientOffsetRatioX":0,"markerSize":0,"fillForeColor":{"red":255,"green":0,"blue":0,"alpha":255},"fillGradientOffsetRatioY":0,"markerWidth":0,"markerAngle":0,"fillSymbolID":0,"lineColor":{"red":0,"green":0,"blue":0,"alpha":255},"markerSymbolID":0,"lineWidth":0.01,"markerHeight":0,"fillOpaqueRate":100,"fillBackOpaque":false,"fillBackColor":{"red":255,"green":255,"blue":255,"alpha":255},"fillGradientMode":"NONE","lineSymbolID":0,"fillGradientAngle":0}}'
        httpretty.register_uri(httpretty.GET, base_uri + "/services/cache-World/rest/maps/World.json",
                               body=get_map_body, status=200)
        get_mng_service_body = '{"isStreamingService":false,"interfaceTypes":"com.supermap.services.rest.RestServlet","isSet":false,"instances":[{"interfaceType":"com.supermap.services.rest.RestServlet","componentType":"com.supermap.services.components.impl.MapImpl","name":"cache-World/rest","componentSetName":null,"authorizeSetting":{"permittedRoles":[],"deniedRoles":[],"type":"PUBLIC"},"id":null,"componentName":"map-smtiles-World2","interfaceName":"rest","enabled":true,"status":"OK"}],"isClusterService":false,"type":"com.supermap.services.components.impl.MapImpl","interfaceNames":"rest","clusterInterfaceNames":"","isDataflowService":false,"component":{"isScSet":false,"scSetSetting":null,"scSetting":{"disabledInterfaceNames":"","instanceCount":0,"name":"map-smtiles-World2","alias":"","interfaceNames":"rest","type":"com.supermap.services.components.impl.MapImpl","config":{"cacheReadOnly":false,"cacheConfigs":null,"useVectorTileCache":false,"utfGridCacheConfig":null,"tileCacheConfig":null,"vectorTileCacheConfig":null,"expired":0,"logLevel":"info","outputPath":"","useCache":false,"outputSite":"","useUTFGridCache":false,"clip":false},"providers":"smtiles-World2","enabled":true}},"providerNames":"smtiles-World2","name":"cache-World","alias":"","providers":[{"spsetSetting":null,"isSPSet":false,"spSetting":{"name":"smtiles-World2","alias":null,"innerProviders":null,"type":"com.supermap.services.providers.SMTilesMapProvider","config":{"dataPrjCoordSysType":null,"watermark":null,"cacheVersion":"4.0","outputPath":"./output","filePath":"/etc/icloud/SuperMapiServer/bin/iserver/output/sqlite113/World_1881337416_256X256_PNG.smtiles","cacheMode":null,"name":null,"outputSite":"http://{ip}:{port}/iserver/output/"},"enabled":true}}]}'
        httpretty.register_uri(httpretty.GET, base_uri + "/manager/services/cache-World.json",
                               body=get_mng_service_body, status=200)
        update_smtilestileset(base_uri, 'admin', 'iserver', 'cache-World',
                              os.path.join(os.path.dirname(os.path.abspath(__file__)), "World.zip"), 'World',
                              (-180, 90), (-180, -90, 180, 90), remote_workspace=True, quiet=True)

    @httpretty.activate
    def test_update_smtilestilset_storageid(self):
        base_uri = "http://192.168.20.158:8090/iserver"
        # do login
        loginuri = base_uri + '/services/security/login.json'
        httpretty.register_uri(httpretty.POST, loginuri, status=201,
                               set_cookie='JSESSIONID=958322873908FF9CA99B5CB443ADDD5C',
                               body='{"referer":"/iserver/","reason":null,"succeed":true}')
        # do post workspace
        httpretty.register_uri(httpretty.POST, base_uri + "/manager/workspaces.json",
                               body='[{"serviceType": "RESTMAP", "serviceAddress": "' + base_uri + '/services/data-world2/rest' + '"}]',
                               status=201)
        # do post tile jobs
        post_tile_jobs_body = '{"postResultType":"CreateChild","newResourceID":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","succeed":true,"customResult":{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":null,"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[1.4062499999999996,0.7041106029214795,0.35205530146073977,0.17602765073036988,0.08801382536518494,0.04400691268259247,0.022003456341296235,0.011001728170648107,0.005500864085324063,0.002750432042662044],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":true,"refMapRestAdress":null,"scaleDenominators":[5.91658710909131E8,2.96244033181848E8,1.48122016590924E8,7.4061008295462E7,3.7030504147731E7,1.85152520738655E7,9257626.03693275,4628813.01846637,2314406.50923319,1157203.2546166],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0.75,"storageType":null,"vectorBounds":null,"vectorParameter":null}},"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json"}'
        httpretty.register_uri(httpretty.POST, base_uri + "/manager/tileservice/jobs.json", body=post_tile_jobs_body,
                               status=200)
        # do get tile job
        get_tile_jobs_body = '{"id":"d7bff309-8f7f-48bb-9c4f-bf9b9224fb41","state":{"masterAddress":null,"dataPreProcessBuildConfig":null,"tileMatrixEdgeCount":45,"dataPreProcessState":null,"total":122018,"startTime":1515746622436,"deployedCompleted":8,"tasks":[{"masterAddress":null,"isRetile":false,"jobId":"2288b51b-562c-4db7-a45d-8a2782126b24","tileMatrixToBuilds":[{"novalueFlags":null,"columnCount":45,"rowCount":45,"startingIndex":{"columnIndex":180,"rowIndex":0}}],"taskType":"TILETASK","originalPoint":{"x":-180,"y":90},"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"id":"650b0c99-db3e-4787-a5c7-58f1b5ba0f7a","state":{"workerId":null,"lastIndex":null,"completed":0,"runState":null},"deployTime":0,"totalTileCount":2025,"dataPreProcessInfo":null}],"buildingScale":{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"nextIndex":{"columnIndex":225,"rowIndex":0},"completed":8100,"completedBytes":0,"completedRegion":null},"scaleInfos":[{"failedRegion":null,"total":122018,"totalMatrix":null,"workerBuildingInfos":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","lastTileRegion":null,"name":"ubuntu_8090","controllable":false,"completed":8100,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"scaleDenominator":1200000,"matrixes":[{"novalueFlags":null,"columnCount":494,"rowCount":247,"startingIndex":{"columnIndex":0,"rowIndex":0}}],"completed":8100,"completedBytes":18020057,"completedRegion":null}],"pureColorTileCount":5733,"deployedTotal":2025,"remainTime":1019842,"completed":8100,"analystBlankPercentage":0,"tasksToRetry":[],"deployingDataWorkerInfo":[],"scaleConfigs":[{"scaleDenominator":1200000,"cacheRegions":null,"excludeRegions":null,"resolution":0,"tileBoundsWidth":"0.7301506629323473","tileBoundsHeight":"0.730150662932347"}],"completedScale":[],"runState":"COMPLETED","noFeaturesTileCount":0,"deployedWorkerInfo":[{"masterAddress":null,"hostName":"ubuntu","address":null,"port":8090,"ip":"192.168.20.158","name":"ubuntu_8090","controllable":false,"id":"38efbec5de2846d1bd499866637aec46","local":true,"token":null}],"completedBytes":18020057,"speedPerSecond":31,"elapsedTime":63297},"targetTilesetInfo":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite/World_1152242556_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"info":{"originalPoint":{"x":-180,"y":90},"fileVerificationMode":"FILESIZE","cacheRegions":null,"utfGridParameter":null,"resolutions":[0.0028521510270794817],"dataConnectionString":"str","transparent":false,"tileVersionDescription":null,"realspaceParameter":null,"createStandardMBTiles":false,"epsgCode":4326,"createNewTileVersion":false,"mapName":"World","convertToPng8":false,"refMapRestAdress":null,"scaleDenominators":[1200000],"cacheVersion":null,"parentTileVersion":null,"format":"PNG","cacheBounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"storeConfig":{"innerTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite","type":"SMTiles"},"tileStorageServers":[],"type":"Remote","token":null},"dataPreProcessInfo":null,"actualTileVersion":null,"taskAssignmentType":"DEFAULT","tileType":"Image","autoAvoidEffectEnabled":false,"useLocal":true,"tileSize":"SIZE_256","compressionQuality":0,"storageType":null,"vectorBounds":null,"vectorParameter":null}}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/tileservice/jobs/d7bff309-8f7f-48bb-9c4f-bf9b9224fb41.json',
                               body=get_tile_jobs_body, status=200)
        # post update jobs
        post_update_jobs_body = '{"postResultType":"CreateChild","newResourceID":"f1341552-d09f-456d-8c06-0b04612b5762","succeed":true,"newResourceLocation":"http://192.168.20.158:8090/iserver/manager/tilesetupdatejobs/f1341552-d09f-456d-8c06-0b04612b5762.json"}'
        httpretty.register_uri(httpretty.POST, base_uri + '/manager/tilesetupdatejobs.json', body=post_update_jobs_body,
                               status=200)
        # get update job
        get_update_job_body = '{"id":"f1341552-d09f-456d-8c06-0b04612b5762","state":{"total":14654,"completedScales":[{"tileMatrix":{"novalueFlags":null,"columnCount":3,"rowCount":2,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":6,"scaleDenominator":2.4999999999934435E8,"completed":6,"resolution":0.59419813064}],"actualCompleted":12,"toExportScales":[{"tileMatrix":{"novalueFlags":null,"columnCount":10,"rowCount":5,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":50,"scaleDenominator":6.399999999821653E7,"completed":0,"resolution":0.15211472144},{"tileMatrix":{"novalueFlags":null,"columnCount":19,"rowCount":10,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":190,"scaleDenominator":3.1999999999949735E7,"completed":0,"resolution":0.076057360722},{"tileMatrix":{"novalueFlags":null,"columnCount":37,"rowCount":19,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":703,"scaleDenominator":1.5999999999974867E7,"completed":0,"resolution":0.038028680361},{"tileMatrix":{"novalueFlags":null,"columnCount":74,"rowCount":37,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":2738,"scaleDenominator":8000000.000197801,"completed":0,"resolution":0.019014340181},{"tileMatrix":{"novalueFlags":null,"columnCount":148,"rowCount":74,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":10952,"scaleDenominator":4000000.000014754,"completed":0,"resolution":0.0095071700903}],"exporttingScale":{"tileMatrix":{"novalueFlags":null,"columnCount":5,"rowCount":3,"startingIndex":{"columnIndex":0,"rowIndex":0}},"total":15,"scaleDenominator":1.2499999999967217E8,"nextIndex":{"columnIndex":2,"rowIndex":6},"completed":6,"resolution":0.29709906532},"startTime":1516238843458,"remainTime":334326,"completed":12,"runState":"COMPLETED","elapsedTime":274,"speedPerSecond":57},"info":{"sourceTilesetInfo":{"metaData":{"scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"originalPoint":{"x":-180,"y":90},"standardMBTiles":false,"resolutions":[0.59419813064,0.29709906532,0.15211472144,0.076057360722,0.038028680361,0.019014340181,0.0095071700903],"tileWidth":256,"mapStatusHashCode":"1318435482","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.1","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"smtiles_tileset_1596041633","tileVersions":null},"targetTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12","type":"SMTiles"},"targetInfo":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"relatedObject":null,"sourceTilesetDesc":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13/World_1318435482_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"sourceTileSourceInfo":{"outputPath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13","type":"SMTiles"},"targetTilesetIdentifier":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileVersions":null,"targetTilesetInfo":{"metaData":{"scaleDenominators":[2.4999999999934435E8,1.2499999999967217E8,6.399999999821653E7,3.1999999999949735E7,1.5999999999974867E7,8000000.000197801,4000000.000014754],"originalPoint":{"x":-180,"y":90},"standardMBTiles":false,"resolutions":[0.59419813064,0.29709906532,0.15211472144,0.076057360722,0.038028680361,0.019014340181,0.0095071700903],"tileWidth":256,"mapStatusHashCode":"1179708792","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.1","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"smtiles_tileset_1596041633","tileVersions":null},"targetTilesetDesc":{"filePath":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite12/World_1179708792_256X256_PNG.smtiles","name":"smtiles_tileset_1596041633"},"sourceTilesetIdentifier":"/etc/icloud/SuperMapiServer/webapps/iserver/output/sqlite13/World_1318435482_256X256_PNG.smtiles"}}'
        httpretty.register_uri(httpretty.GET,
                               base_uri + '/manager/tilesetupdatejobs/f1341552-d09f-456d-8c06-0b04612b5762.json',
                               body=get_update_job_body, status=200)
        # delete map component
        httpretty.register_uri(httpretty.DELETE,
                               base_uri + '/manager/services/data-world2.json',
                               body='{"succeed": true}', status=200)
        # get map info
        get_map_body = '{"viewBounds":{"top":76.05736072192,"left":-76.05736072192,"bottom":-76.05736072192,"leftBottom":{"x":-76.05736072192,"y":-76.05736072192},"right":76.05736072192,"rightTop":{"x":76.05736072192,"y":76.05736072192}},"viewer":{"leftTop":{"x":0,"y":0},"top":0,"left":0,"bottom":256,"rightBottom":{"x":256,"y":256},"width":256,"right":256,"height":256},"distanceUnit":null,"minVisibleTextSize":0,"coordUnit":"DEGREE","scale":4.0000000000104906E-9,"description":"","paintBackground":false,"maxVisibleTextSize":0,"maxVisibleVertex":0,"clipRegionEnabled":false,"antialias":false,"textOrientationFixed":false,"angle":0,"prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"minScale":0,"markerAngleFixed":false,"overlapDisplayedOptions":null,"visibleScales":[4.0000000000104906E-9,8.000000000020981E-9,1.5625000000435417E-8,3.125000000004909E-8,6.250000000009817E-8,1.2499999999690936E-7,2.499999999990779E-7],"visibleScalesEnabled":true,"customEntireBoundsEnabled":false,"clipRegion":null,"maxScale":0,"customParams":"","center":{"x":0,"y":0},"dynamicPrjCoordSyses":[{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}}],"colorMode":null,"textAngleFixed":false,"overlapDisplayed":false,"userToken":{"userID":""},"cacheEnabled":true,"dynamicProjection":false,"autoAvoidEffectEnabled":true,"customEntireBounds":null,"name":"World","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"backgroundStyle":{"fillGradientOffsetRatioX":0,"markerSize":0,"fillForeColor":{"red":255,"green":0,"blue":0,"alpha":255},"fillGradientOffsetRatioY":0,"markerWidth":0,"markerAngle":0,"fillSymbolID":0,"lineColor":{"red":0,"green":0,"blue":0,"alpha":255},"markerSymbolID":0,"lineWidth":0.01,"markerHeight":0,"fillOpaqueRate":100,"fillBackOpaque":false,"fillBackColor":{"red":255,"green":255,"blue":255,"alpha":255},"fillGradientMode":"NONE","lineSymbolID":0,"fillGradientAngle":0}}'
        httpretty.register_uri(httpretty.GET, base_uri + "/services/cache-World/rest/maps/World.json",
                               body=get_map_body, status=200)
        get_mng_service_body = '{"isStreamingService":false,"interfaceTypes":"com.supermap.services.rest.RestServlet","isSet":false,"instances":[{"interfaceType":"com.supermap.services.rest.RestServlet","componentType":"com.supermap.services.components.impl.MapImpl","name":"cache-World/rest","componentSetName":null,"authorizeSetting":{"permittedRoles":[],"deniedRoles":[],"type":"PUBLIC"},"id":null,"componentName":"map-smtiles-World2","interfaceName":"rest","enabled":true,"status":"OK"}],"isClusterService":false,"type":"com.supermap.services.components.impl.MapImpl","interfaceNames":"rest","clusterInterfaceNames":"","isDataflowService":false,"component":{"isScSet":false,"scSetSetting":null,"scSetting":{"disabledInterfaceNames":"","instanceCount":0,"name":"map-smtiles-World2","alias":"","interfaceNames":"rest","type":"com.supermap.services.components.impl.MapImpl","config":{"cacheReadOnly":false,"cacheConfigs":null,"useVectorTileCache":false,"utfGridCacheConfig":null,"tileCacheConfig":null,"vectorTileCacheConfig":null,"expired":0,"logLevel":"info","outputPath":"","useCache":false,"outputSite":"","useUTFGridCache":false,"clip":false},"providers":"smtiles-World2","enabled":true}},"providerNames":"smtiles-World2","name":"cache-World","alias":"","providers":[{"spsetSetting":null,"isSPSet":false,"spSetting":{"name":"smtiles-World2","alias":null,"innerProviders":null,"type":"com.supermap.services.providers.SMTilesMapProvider","config":{"dataPrjCoordSysType":null,"watermark":null,"cacheVersion":"4.0","outputPath":"./output","filePath":"/etc/icloud/SuperMapiServer/bin/iserver/output/sqlite113/World_1881337416_256X256_PNG.smtiles","cacheMode":null,"name":null,"outputSite":"http://{ip}:{port}/iserver/output/"},"enabled":true}}]}'
        httpretty.register_uri(httpretty.GET, base_uri + "/manager/services/cache-World.json",
                               body=get_mng_service_body, status=200)
        get_datastore_body = '{"tileSourceInfo":{"fdhtGroups":[["192.168.20.182:11411"]],"fdfsTrackers":["192.168.20.182:22122"],"type":"FastDFS","datastoreType":"TILES"},"connct":true,"currentCount":3,"id":"test","totalCount":3,"tilesetInfos":[{"metaData":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"originalPoint":{"x":-180,"y":90},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585],"tileWidth":256,"mapStatusHashCode":"914734962","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.0","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World","tileHeight":256},"name":"fastdfs_tileset_1596041633","tileVersions":[{"parent":null,"name":"719ed1a8-cdbf-46cf-a15f-f0dd7c123042","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000,1200000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933,0.0028521510270794817]},"desc":"first version of tileset 1596041633","timestamp":1522475371281},{"parent":"719ed1a8-cdbf-46cf-a15f-f0dd7c123042","name":"dcd4f33d-fc48-4f80-b32a-db2ee440bd01","update":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V2","timestamp":1522640492532},{"parent":"dcd4f33d-fc48-4f80-b32a-db2ee440bd01","name":"c12d55a4-44dc-474c-a73d-65ad60596325","update":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"2018-04-02 14:27:38","timestamp":1522650458922},{"parent":"c12d55a4-44dc-474c-a73d-65ad60596325","name":"6a6da772-a615-49c4-9565-0c7407d54d50","update":{"scaleDenominators":[1200000,4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.0028521510270794817,0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"2018-04-02 14:43:51","timestamp":1522651433013}]},{"metaData":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"originalPoint":{"x":-180,"y":90},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585],"tileWidth":256,"mapStatusHashCode":"-851947260","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"tileRuleVersion":"1.0","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"World Map","tileHeight":256},"name":"fastdfs_tileset_-341902723","tileVersions":[{"parent":null,"name":"8addaea9-d42b-45cc-832a-70bdc75edcd5","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933]},"desc":"first version of tileset -341902723","timestamp":1522637457998},{"parent":"8addaea9-d42b-45cc-832a-70bdc75edcd5","name":"ea676727-2a10-49d5-9df4-58113c7d3559","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933]},"desc":"V2","timestamp":1522638495044},{"parent":"ea676727-2a10-49d5-9df4-58113c7d3559","name":"0026b12e-1235-4640-9361-ce350751c810","update":{"scaleDenominators":[2.5E8,1.25E8,6.4E7,3.2E7,1.6E7,8000000,4000000],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.5941981306415585,0.29709906532077923,0.15211472144423893,0.07605736072211947,0.03802868036105973,0.019014340180529866,0.009507170090264933]},"desc":"V3","timestamp":1522639669452},{"parent":"0026b12e-1235-4640-9361-ce350751c810","name":"6d5ff0df-43ca-4e26-b254-885c2810fc0c","update":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V4","timestamp":1522639821615},{"parent":"6d5ff0df-43ca-4e26-b254-885c2810fc0c","name":"e0715672-afdc-409b-8462-aa38f2686ff0","update":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V5","timestamp":1522640036808},{"parent":"e0715672-afdc-409b-8462-aa38f2686ff0","name":"3220e3a9-5a4d-440a-b310-e4423db9ad06","update":{"scaleDenominators":[4000000,8000000,1.6E7,3.2E7,6.4E7,1.25E8,2.5E8],"bounds":{"top":90,"left":-180,"bottom":-90,"leftBottom":{"x":-180,"y":-90},"right":180,"rightTop":{"x":180,"y":90}},"resolutions":[0.009507170090264933,0.019014340180529866,0.03802868036105973,0.07605736072211947,0.15211472144423893,0.29709906532077923,0.5941981306415585]},"desc":"V6","timestamp":1522640206526}]},{"metaData":{"scaleDenominators":[4000,8000,16000,32000,64000,125000,250000],"originalPoint":{"x":-74.04927681498597,"y":40.849904671748604},"resolutions":[9.5071700903125E-6,1.901434018046875E-5,3.802868036109375E-5,7.605736072210938E-5,1.5211472144429687E-4,2.970990653208203E-4,5.941981306415624E-4],"tileWidth":256,"mapStatusHashCode":"940039246","transparent":false,"mapParameter":null,"tileType":"Image","tileFormat":"PNG","bounds":{"top":40.849904671748604,"left":-74.04927681498597,"bottom":40.650255180584914,"leftBottom":{"x":-74.04927681498597,"y":40.650255180584914},"right":-73.84962732382229,"rightTop":{"x":-73.84962732382229,"y":40.849904671748604}},"tileRuleVersion":"1.0","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"mapName":"summaryMesh_max_passenger_count_Map","tileHeight":256},"name":"fastdfs_tileset_-110794161","tileVersions":[{"parent":null,"name":"f6ebafff-da0d-4740-a766-1c45b80a8b0c","update":{"scaleDenominators":[250000,125000,64000,32000,16000,8000,4000],"bounds":{"top":40.849904671748604,"left":-74.04927681498597,"bottom":40.650255180584914,"leftBottom":{"x":-74.04927681498597,"y":40.650255180584914},"right":-73.84962732382229,"rightTop":{"x":-73.84962732382229,"y":40.849904671748604}},"resolutions":[5.941981306415624E-4,2.970990653208203E-4,1.5211472144429687E-4,7.605736072210938E-5,3.802868036109375E-5,1.901434018046875E-5,9.5071700903125E-6]},"desc":"first version of tileset -110794161","timestamp":1522465329328}]}]}'
        httpretty.register_uri(httpretty.GET, base_uri + '/manager/datastores/test.json',
                               body=get_datastore_body, status=200)
        update_smtilestileset(base_uri, 'admin', 'iserver', 'cache-World',
                              os.path.join(os.path.dirname(os.path.abspath(__file__)), "World.zip"), 'World',
                              (-180, 90), (-180, -90, 180, 90), storageid='test', remote_workspace=True, quiet=True)

    @mock.patch('sys.stdout', new_callable=StringIO)
    @mock.patch('builtins.input', side_effect=['Y'])
    @httpretty.activate
    def test_confirm(self, mock_in, mock_out: StringIO):
        d = {'address': 'http://localhost:8090/iserver'}
        str = confirm(**d)
        self.assertEqual(mock_out.getvalue(), '\n: http://localhost:8090/iserver\n?(Y/N) ')
        self.assertEqual(str, 'Y')


class TestZipDir(TestCase):
    def test(self):
        dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        filetoread = zipdir(os.path.join(dir, 'workspace.sxwu'))
        from io import BytesIO
        import zipfile
        with BytesIO() as output:
            data = filetoread.read();
            output.write(data)
            with zipfile.ZipFile(output) as zfile:
                filecount = 0
                allfiles = []
                for root, dirs, files in os.walk(dir):
                    filecount += len(files)
                    allfiles.extend(files)
                self.assertEqual(len(zfile.namelist()), filecount, str(zfile.namelist()) + str(allfiles))


from iclientpy.rest.api.updatetileset import _upload_workspace_file as uploadworkspace
from iclientpy.rest.api.management import Management
from unittest.mock import MagicMock
import io


class MockZipFile:
    def __init__(self, file, mode="r", compression=0, allowZip64=True):
        self.files = []

    def __iter__(self):
        return iter(self.files)

    def __enter__(self):
        return self

    def __exit__(self, type, value, traceback):
        self.close()

    def write(self, filename, arcname=None, compress_type=None):
        self.files.append(filename)

    def close(self):
        pass


class TestUploadWorkspace(TestCase):
    @mock.patch("builtins.open", new_callable=mock.mock_open, read_data="data")
    def test_zip(self, mock_file):
        mng = Management()
        mng.post_fileuploadtask = MagicMock(unsafe=True)
        w_loc = os.path.join(os.path.dirname(os.path.abspath(__file__)), "World.zip")
        post_result = PostFileUploadTaskResult()
        post_result.filePath = './World/'
        mng.post_fileuploadtask.return_value = post_result
        self.assertEqual(uploadworkspace(mng, w_loc, 'id'), './World/./World/World.sxwu')
        mng.post_fileuploadtask.assert_called_with('id', mock_file(), './World.zip', overwrite=True, unzip=True)

    @mock.patch("zipfile.ZipFile", MockZipFile)
    def test_not_zip(self):
        mng = Management()
        mng.post_fileuploadtask = MagicMock(unsafe=True)
        post_result = PostFileUploadTaskResult()
        post_result.filePath = './World/'
        mng.post_fileuploadtask.return_value = post_result
        w_loc = os.path.join(os.path.dirname(os.path.abspath(__file__)), "./World.sxwu")
        self.assertEqual(uploadworkspace(mng, w_loc, 'id'), './World/./World.sxwu')
        mng.post_fileuploadtask.assert_called()
